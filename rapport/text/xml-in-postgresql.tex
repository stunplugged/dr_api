I dette kapitel undersøges hvordan funktioner til videoapplikationen ville se ud, hvis ikke skulle hente deres data fra et XML dokument men i stedet hente dataene direkte fra tabeller i en relationel database. Resultatet af et funktionskald skal dog stadig være i form af et resultatsæt beskrevet med XML.

Databasen som vil blive brugt i dette projekt er en PostgreSQL database og der arbejdes udelukkende med data fra XML dokumentet programseries.xml.

\section{Design af tabeller}

Første opgave er at designe nogle tabeller, som kan understøtte indholdet i XML dokumentet. Den første tabel, der skal bruges er en tabel til at holde på selve XML dokumentet i sin komplette tilstand.  Til det formål er tabellen ”downloadedXML” oprettet. Denne tabel indeholder to kolonner, en til navnet på XML dokumentet (docmentTitle) og en til selve indholdet af dokumentet (documentContent) som er af typen XML.

Fra undersøgelsen af programseries.xml, tilbage i kapitel 2.2, er det allerede kendt at der findes en 0 til mange relation imellem en programserie og programseriens labels, altså kategorier. I figur \ref{postgresql:ER-diagram} ses et ER-diagram, som viser denne relation.  Derfor er der oprettet en tabel udelukkende til labels og en tabel udelukkende til indholdet af en programserie. Til at beskrive relationen, at en programserie har 0 til mange label’s og at label’s har 0 til mange programserier, så er der oprettet en tabel, som hedder slugLabel, der har en reference til label tabellen og en reference ti l programserie tabellen. Dermed en denne relation beskrevet i databasen og tabellerne er nu klar til at indlæst data i sig.

\begin{figure}[ht]
  \centering
   \includegraphics[width=1.1\textwidth]{pic/ER_programserie.png}
   \caption{ER-diagram over tabel-design.}
   \label{postgresql:ER-diagram}
\end{figure}

\section{Oprettelse af label’s}

Når XML dokumentet er indlæst i tabellen downloadedXML, så skal der som det første oprettes labels til alle de kategorier, som findes i dokumentet programseries.xml. Til dette formål er funktionen ” getAndInsertAllLabels()”, som ses i figur \ref{ code: getAndInsertAllLabels} skabt. Denne funktion benytter et XPath-udtryk til at finde alle tekster til labels og for hver tekst den finder, så undersøges det om der allerede er oprettet en label med den tekst, hvis ikke så indsættes denne nye label i tabellen. 

\begin{figure}[h]
\centering
\begin{BVerbatim}
  labels := (SELECT xpath('//ProgramSerie/Labels/string/text()', 
             downloadedXML.documentContent) FROM downloadedXML);
  FOR i IN array_lower(labels, 1) .. array_upper(labels, 1)
  LOOP
    SELECT labelNo INTO v_found FROM label WHERE label.labelTxt = labels[i];
    IF v_found IS NULL THEN
      INSERT INTO label(labelTxt) VALUES(labels[i]);
    END IF;
  END LOOP;
\end{BVerbatim}
\caption{Udsnit af funktionen getAndInsertAllLabels()}
\label{code: getAndInsertAllLabels }
\end{figure}


