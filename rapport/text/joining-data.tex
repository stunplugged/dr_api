I dette kapitel beskrives forskellige funktioner, som alle har det tilfældes at de alle arbejder på to forskellige XML dokumenter samtidigt eller to versioner af samme XML dokument, men af forskellige dato. 

\section{Find tilgængelige afsnit i en programserie}
Det er ikke altid at alle afsnit af et specifikt program er tilgængeligt i en programserie. Eksempelvis vil Danmarks Radio kun have et begrænset antal af afsnit, liggende tilgængeligt for brugerne, når det drejer sig om relativt kostbarer produktioner som dramaserier, der efterfølgende skal kunne sælges på eksempelvis DVD. I disse tilfælde vil eksempelvis kun de to sidste afsnit være tilgængelige i en kort periode.

Det er derfor interessant at få udarbejdet en funktion, som kan returnere det totale antal af afsnit samt antallet af afsnit som er tilgængelige netop nu.

Til dette formål skal elementet med navnet \ele{VideoCount}, fra dokumentet programseries.xml, anvendes som det antal af afsnit, der total findes i en specifik programserie. Til at finde antallet af afsnit, som faktisk er tilgængelige netop nu, bruges aggregeringsfunktionen Count() på elementerne med navnet \ele{ProgramSerieVideo} i dokumentet all.xml, hvor det angives som betingelse, at der kun skal medtages de elementer, som indeholder samme værdi i elementet \ele{ProgramSerieSlug} som i elementet \ele{Slug} fra dokumentet programseries.xml.  Desuden ønskes kun de videoer, som har elementet \ele{Expired} sat til falsk, da det kunne tænkes at en video ikke er blevet fjernet fra dokumentet all.xml, men at selve linket til videoen ikke er gyldigt længere. 

For at skabe et resultatset, for en helt specifik programserie \ele{Slug}, som kun indeholder antal videoer totalt og antal tilgængelige videoer, for en helt specifike programserie, så er der implementeret to funktioner, som hedder henholdsvis checkVideoCount() og countVideoSlugs().

Funktionen checkVideoCount() tager imod 3 argumenter, som alle er af datatype string. SlugName er navnet på selve programserien fx ”so-ein-ding”, de to øvrige argumenter er navnene på XML filerne, som henholdsvis indeholder listen af programserier (programseriesFileName) og liste over alle de enkelte videoer (videoFileName). Funktionen starter med at bruge et XPath-udtryk til at finde første del af resultatsættet, som er indholdet af elementet VideoCount, fra listen af programserier. Derefter kaldes en hjælpefunktion, som hedder countVideoSlugs(), hvor aggregeringsfunktionen count() anvendes til at sammentælle antallet af afsnit, som findes i XML dokumentet, der indeholder alle videoer. Betingelse for at blive talt med er, som tidligere nævnt, at elementet \ele{Expired} skal være sat til værdien falsk. Hjælpefunktionen sender resultatet retur som en integer til funktionen checkVideoCount(). Det samlede resultatset returens nu som en sekvens bestående af to elementer: \ele{totalVideoCount} og \ele{availableVideoCount}. For at kunne returnere en sekvens af elementer, er funktionen checkVideoCount() defineret til at returnere element()* som betyder at 0 til mange elementer kan forventes returneret fra funktionen. I dette tilfælde vil antallet af elementer dog altid være to, hvoraf det ene element (totalVideoCount) kan indeholde en tom værdi, hvis der forespørges på en programserie (SlugName), som ikke findes i listen over programserier.

\begin{figure}[ht]
\begin{lstlisting}[style=FAKE_XQUERY, language=XQUERY]
declare function dr:checkVideoCount
  ($slugName as xs:string, $programseriesFileName as xs:string, $videoFileName as xs:string ) as element()*{
    let $totalCount := doc($programseriesFileName)/ArrayOfProgramSerie/ProgramSerie[Slug = $slugName]/VideoCount/text()
    return( 
      <totalVideoCount>{$totalCount}</totalVideoCount>,
      <availableVideoCount>{dr:countVideoSlugs($slugName, $videoFileName)}</availableVideoCount>
     )
};

declare function dr:countVideoSlugs
  ($slugName as xs:string, $videoFileName as xs:string ) as xs:integer{

    count(for $programSerieVideo in doc($videoFileName)//ProgramSerieVideo
          where $programSerieVideo[ProgramSerieSlug = $slugName] and $programSerieVideo/Expired/text() = "false"
          return $programSerieVideo)
};

\end{lstlisting}
\caption{Funktion til at finde antal tilgængelige afsnit i en programserie.}
\label{joining:checkVideoCount}
\end{figure}

\section{Find ændringer imellem to versioner af samme XML dokument}
Set over længere tid vil videoer eller programserier blive tilføjet og fjernet til og fra XML dokumenterne eller måske bare få opdateret enkelte af deres beskrivende elementer som fx \ele{Description}, \ele{NewestVideoId} eller \ele{VideoCount} i dokumentet programseries.xml. Da det kunne tænkes at videoapplikationen, som dette projekt skal understøtte, anvender en form for intern lagring (cache) af eksempelvis et billede til videoen eller teksten, som beskriver videoen, så vil der være nyttigt at kunne vedligeholde dette intern lager ved at kunne identificeres ændringer siden sidste version af XML dokumentet.

Alle de ændringer som bliver identificeret vil blive indpakket i et nyt XML dokumentet, hvor de grupperes efter om det er en programserie, som er blevet tilføjet, fjernet eller opdateret/ændret imellem de to versioner af XML dokumenterne. 

\subsection{Hovedfunktionalitet}
For at kunne identificeres ændringer imellem to versioner af dokumentet programseries.xml, så er der implementet funktionen compareDocuments(), som tager imod de to versioner af dokumentet og giver et resultatsæt tilbage, som indeholder elementer, der er blevet tilføjet, fjernet eller opdateret. Funktionen compareDocuments() anvender hjælpefunktioner til at skabe de enkelte dele af resultatsættet. Disse hjælpefunktioner er beskrevet i underafsnittende herunder.

\subsection{Tilføjelse eller fjernelse af programserier}
Funktionen til at identificeres om en programserie er blevet tilføjet eller fjernet er døbt leftExceptRight() og udfører except-funktionalitet, hvor elemeterne fra sekvensen på venstre side returneres, hvis de ikke forekommer i sekvensen på højre side. For at udfører expect-funktionaliteten er der anvendt et "Context Item Expression", som gør at hvert enkelt element fra sekvensen på venstre side bliver evalueret med hele sekvensen på højre side (not(sekHøj[x] = sekVen). Hvis elementet eksistere i sekvensen på højre side er denne evalueringen negativ ellers positiv hvis elementet ikke findes. Dermed returneres kun elementerne hvor evaluering er positiv.

Funktionen leftExceptRight() anvendes to gange som hjælpefunktion, da den nye version af dokumentet skal tjekkes imod den gamle for at finde tilføjende programserier og den gamle version skal tjekkes imod den nye for at finde de programserier, som er fjernet fra dokumentet.

\subsection{Ændring i indhold af programserier}
Funktionen til at identificer om der er ændringer til en specifik programserie, som er indeholdt både i den nye og gamle version af dokumentet programseries.xml er baseret på en join operation, joinSlug(), imellem den gamle og nye version af dokumentet, for at finde fælles programserier for de 2 dokumenter. Join operationen returnere kun en liste af slug elementer, som senere bruges til at identificere programserierne når deres indhold skal sammenlignes. 

I funktionen compareNodes() hentes de specikke programserier fra hver version af dokumentet, hvorefter funktionen compareElement() bliver anvendt til hvert element i programserien.

Funktionen compareElement() sammenligner kun elementer med samme navn og tjekker at deres indhold er identisk. Kun hvis indholdet af det enkelte element er forskelligt returens et ny beskrivende element, som hedder \ele{changedContentProgramSerie}. Dette element indeholder attributten slug, som identificer selve programserien og attributten elementName, som identificer det element navn som har ændret sig. Desuden indeholder elementet \ele{changedContentProgramSerie} et element fra hver version af de oprindelige dokumenter (contentFile1 og contentFile2), således at det er muligt at se hvad der selve forskellen imellem de to versioner.   
