I dette kapitel beskrives forskellige funktioner, som alle har det tilfældes at de alle arbejder på 2 forskellige XML dokumenter samtidigt eller 2 versioner af samme XML dokumenter, men af forskellige dato. 

\section{Antal tilgængelige afsnit i en programserie}
Det er ikke altid at alle afsnit af et specifikt program er tilgængeligt i en programserie. Eksempelvis vil Danmarks Radio kun have et begrænset antal af afsnit, liggende tilgængeligt for brugerne, når det drejer sig om relativt kostbarer produktioner som dramaserier, der efterfølgende skal kunne sælges på eksempelvis DVD. I disse tilfælde vil eksempelvis kun de 2 sidste afsnit være tilgængelige i en kort periode.

Det er derfor interessant at få udarbejdet en funktion, som kan returnere det totale antal af afsnit samt antallet af afsnit som er tilgængelige netop nu.

Til dette formål skal elementet med navnet VideoCount, fra dokumentet programseries.xml, anvendes som det antal af afsnit, der total findes i en specifik programserie. Til at finde antallet af afsnit, som faktisk er tilgængelige netop nu, bruges aggregeringsfunktionen Count på elementerne med navnet ProgramSerieVideo i dokumentet all.xml, hvor det angives som betingelse, at der kun skal medtage de elementer, som indeholder samme værdi i elementet ProgramSerieSlug som i elementet Slug fra dokumentet programseries.xml.  Desuden ønskes kun de videoer, som har elementet Expired sat til falsk, da det kunne tænkes at en video ikke er blevet fjernet fra dokumentet all.xml, men at selve linket til videoen ikke er gyldig længere. 

For at skabe et resultatset, for en helt specifik programserie (Slug), som kun indeholder antal videoer total og antal tilgængelige videoer, for en helt specifike programserie, så er der implementeret 2 funktioner, som hedder henholdsvis checkVideoCount og countVideoSlugs.

Funktionen checkVideoCount tager imod 3 argumenter, som alle er af datatype string. SlugName er navnet på selve programserien fx ”so-ein-ding”, de 2 øvrige argumenter er navnene på XML filerne, som henholdsvis indeholder listen af programserier (programseriesFileName) og liste over alle de enkelte videoer (videoFileName). Funktionen starter med at bruge et XPath-udtryk til at finde første del af resultatsættet, som er indholdet af elementet VideoCount, fra listen af programserier. Derefter kaldes en hjælpefunktion, som hedder countVideoSlugs, hvor aggregeringsfunktionen count anvendes til sammentælle antallet af afsnit, som findes i XML dokumentet, der indeholder alle videoer. Betingelse for at blive talt med er, som tidligere nævnt, at elementet Expired skal være sat til værdien falsk. Hjælpefunktionen sender resultatet retur som en integer til funktionen checkVideoCount. Det samlede resultatset returens nu som en sekvens bestående af to elementer: totalVideoCount og availableVideoCount. For at kunne returnere en sekvens af elementer, er funktionen checkVideoCount defineret til at returnere element()* som betyder at 0 til mange elementer kan forventes returneret fra funktionen. I dette tilfælde vil antallet af elementer dog altid være 2, hvoraf det ene element (totalVideoCount) kan indeholde en tom værdi, hvis der forespørges på en programserie (SlugName), som ikke findes i listen over programserier.

\begin{figure}[ht]
\begin{lstlisting}[style=FAKE_XQUERY, language=XQUERY]
declare function dr:checkVideoCount
  ($slugName as xs:string, $programseriesFileName as xs:string, $videoFileName as xs:string ) as element()*{
    let $totalCount := doc($programseriesFileName)/ArrayOfProgramSerie/ProgramSerie[Slug = $slugName]/VideoCount/text()
    return( 
      <totalVideoCount>{$totalCount}</totalVideoCount>,
      <availableVideoCount>{dr:countVideoSlugs($slugName, $videoFileName)}</availableVideoCount>
     )
};

declare function dr:countVideoSlugs
  ($slugName as xs:string, $videoFileName as xs:string ) as xs:integer{

    count(for $programSerieVideo in doc($videoFileName)//ProgramSerieVideo
          where $programSerieVideo[ProgramSerieSlug = $slugName] and $programSerieVideo/Expired/text() = "false"
          return $programSerieVideo)
};

\end{lstlisting}
\caption{Funktion til at finde antal tilgængelige afsnit i en programserie }
\label{joining:checkVideoCount}
\end{figure}

TODO: Insert stuff about joining data

Which XML documents to be joined and why?

Compare the same XML document different dates.
( Is something added,removed,updated ? list results)